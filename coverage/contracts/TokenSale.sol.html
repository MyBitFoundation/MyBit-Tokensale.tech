<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/TokenSale.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> TokenSale.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">97.62% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>41/42</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">50% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>13/26</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">90.91% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>10/11</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">97.83% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>45/46</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity 0.4.24;
&nbsp;
import './SafeMath.sol';
import './ERC20Interface.sol';
&nbsp;
// TODO: add mechanism for situation nobody funds in a day
contract TokenSale {
  using SafeMath for *;
&nbsp;
&nbsp;
  struct Day {
    uint weiPerToken;       // // amount of wei received per MYB token
    uint dayIncome;
    mapping (address =&gt; uint) previousWeiPerToken;
    mapping (address =&gt; uint) weiContributed;
    mapping (address =&gt; uint) claimableTokens;
  }
&nbsp;
  address public owner;
  uint constant scalingFactor = 1e32;
  uint constant decimals = 100000000000000000000;
  uint16 constant numDays = uint16(365);
  ERC20Interface mybToken;
&nbsp;
  uint public start;
  uint public tokensPerDay;
&nbsp;
  mapping (uint16 =&gt; Day) public day;
&nbsp;
  constructor(address _mybToken)
  public {
    mybToken = ERC20Interface(_mybToken);
    owner = msg.sender;
&nbsp;
  }
&nbsp;
  function startSale(uint _totalAmount)
  external
  returns (bool){
    <span class="missing-if-branch" title="else path not taken" >E</span>require(msg.sender == owner);
    // uint totalAmount = tokensPerDay.mul(356);
    <span class="missing-if-branch" title="else path not taken" >E</span>require(mybToken.transferFrom(msg.sender, address(this), _totalAmount));
    tokensPerDay = _totalAmount.div(numDays);
    start = now;
    return true;
  }
&nbsp;
  function fund(uint16 _day)
  payable
  duringSale
  public {
      <span class="missing-if-branch" title="else path not taken" >E</span>require(dayFor(now) &lt;= _day);
      <span class="missing-if-branch" title="else path not taken" >E</span>require(msg.value &gt; 0);
      Day storage today = day[_day];
      today.dayIncome = today.dayIncome.add(msg.value);
      //today.weiPerToken = today.weiPerToken.add(msg.value.mul(scalingFactor).div(tokensPerDay));
      today.weiPerToken = today.dayIncome.mul(decimals).div(tokensPerDay);
      today.weiContributed[msg.sender] = today.weiContributed[msg.sender].add(msg.value);
      emit LogTokensPurchased(msg.sender, msg.value, _day, today.weiPerToken, today.weiContributed[msg.sender]);
  }
&nbsp;
&nbsp;
  // @notice Updates claimableTokens, sends all wei to the token holder
  function withdraw(uint16 _day)
  public
  returns (bool) {
      <span class="missing-if-branch" title="else path not taken" >E</span>require(dayFinished(_day), 'Day not finished');
      <span class="missing-if-branch" title="else path not taken" >E</span>require(updateclaimableTokens(msg.sender, _day), 'Cannot update claimable tokens');
      Day storage thisDay = day[_day];
      uint _amount = thisDay.claimableTokens[msg.sender];
      delete thisDay.claimableTokens[msg.sender];
      <span class="missing-if-branch" title="else path not taken" >E</span>require(mybToken.transfer(msg.sender, _amount), 'Cannot transfer tokens');
      emit LogTokensCollected(msg.sender, _amount, _day, thisDay.weiPerToken, thisDay.weiContributed[msg.sender]);
      return true;
  }
&nbsp;
  // @notice Updates claimableTokens, sends all wei to the token holder
  function batchWithdraw(uint16[] _day)
  public
  returns (bool) {
    uint amount;
    <span class="missing-if-branch" title="else path not taken" >E</span>require(_day.length &lt; 100);
      for (uint i = 0; i &lt; _day.length; i++){
        <span class="missing-if-branch" title="else path not taken" >E</span>require(dayFinished(_day[i]), 'Day not finished');
        <span class="missing-if-branch" title="else path not taken" >E</span>require(updateclaimableTokens(msg.sender, _day[i]), 'Cannot update claimable tokens');
        Day storage thisDay = day[_day[i]];
        uint amountToAdd = thisDay.claimableTokens[msg.sender];
        amount = amount.add(amountToAdd);
        delete thisDay.claimableTokens[msg.sender];
        emit LogTokensCollected(msg.sender, amountToAdd, _day[i], thisDay.weiPerToken, thisDay.weiContributed[msg.sender]);
      }
      <span class="missing-if-branch" title="else path not taken" >E</span>require(mybToken.transfer(msg.sender, amount));
      return true;
  }
&nbsp;
  // @notice Calculates how much value _user holds
  function getTokensForContribution(address _user, uint16 _day)
  public
  view
  returns (uint) {
      Day storage thisDay = day[_day];
      uint tokens = thisDay.weiContributed[_user].mul(decimals).div(thisDay.weiPerToken);
      //uint weiPerTokenDifference = thisDay.weiPerToken.sub(thisDay.previousWeiPerToken[_user]);
      //return weiPerTokenDifference.mul(thisDay.weiContributed[_user]);
      return tokens;
  }
/*
  // @notice Calculates how much wei user is owed. (new income + claimableTokens) / 10**32
  function getUnclaimedAmount(address _user, uint16 _day)
  public
  view
  returns (uint) {
      return (getTokensForContribution(_user, _day).add(day[_day].claimableTokens[_user]).div(scalingFactor));
  }
*/
  // @notice update the amount claimable by this user
  function updateclaimableTokens(address _user, uint16 _day)
  internal
  returns (bool) {
      Day storage thisDay = day[_day];
      thisDay.claimableTokens[_user] = thisDay.weiContributed[_user].mul(decimals).div(thisDay.weiPerToken);
      //thisDay.claimableTokens[_user] = thisDay.claimableTokens[_user].add(getTokensForContribution(_user, _day));
      //thisDay.previousWeiPerToken[_user] = thisDay.weiPerToken;
      return true;
  }
&nbsp;
  // @notice return the day associated with this timestamp
  function dayFor(uint _timestamp)
  public
  view
  returns (uint16) {
      return uint16(_timestamp.sub(start).div(24 hours));
  }
&nbsp;
  // @notice reverts if the current day is greater than 365
  modifier duringSale() {
    <span class="missing-if-branch" title="else path not taken" >E</span>require(dayFor(now) &lt; uint16(365) &amp;&amp; start &gt; 0);
    _;
  }
&nbsp;
  // @notice returns true if _day is finished
  function dayFinished(uint16 _day)
  internal
  view
  returns (bool) {
    <span class="missing-if-branch" title="else path not taken" >E</span>require(dayFor(now) &gt; _day);
    return true;
  }
&nbsp;
  // @notice Fallback function: Accepts Ether and updates ledger (issues dividends)
<span class="fstat-no" title="function not covered" >  function ()</span>
  public {
<span class="cstat-no" title="statement not covered" >      revert()</span>;
  }
&nbsp;
  event LogTokensPurchased(address _contributor, uint _amount, uint16 _day, uint weiPerToken, uint weiContributed);
  event LogTokensCollected(address _contributor, uint _amount, uint16 _day, uint weiPerToken, uint weiContributed);
&nbsp;
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Oct 26 2018 14:37:54 GMT-0700 (PDT)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
